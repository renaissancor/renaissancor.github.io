## 캐시 메모리와 성능 최적화

### 캐시 메모리 기본 개념

* **캐시 라인(Cache Line):** CPU 캐시 메모리의 가장 작은 데이터 단위로, 일반적으로 **64 Byte**입니다. 메모리에서 데이터를 가져올 때 이 64 Byte 단위로 캐시 메모리에 적재됩니다.
* **공간적 지역성(Spatial Locality):** 프로그램이 특정 메모리 주소에 접근할 때, 그 주변의 주소에도 접근할 확률이 높다는 특성을 의미합니다. 캐시 라인은 이 원리를 활용하여, 한 번에 여러 인접한 데이터를 캐시에 올려놓아 캐시 히트(Cache Hit) 확률을 높입니다.
* **캐시 히트(Cache Hit):** CPU가 필요로 하는 데이터가 이미 캐시 메모리에 존재하는 경우를 말하며, 매우 빠르게 데이터에 접근할 수 있습니다.
* **캐시 미스(Cache Miss):** CPU가 필요로 하는 데이터가 캐시 메모리에 없는 경우로, 메인 메모리(RAM)에서 데이터를 가져와야 하므로 속도가 느려집니다.

---

### 캐시 메모리 구조와 주소 매핑 방식

CPU는 복잡한 해시 함수 대신, 메모리 주소의 특정 비트를 인덱스(Index)로 사용하여 캐시 라인을 찾습니다. 이 방식은 검색 시간을 최소화하고, 연속적인 메모리 접근에서 캐시 히트율을 높이는 데 효과적입니다.

* **인덱스(Index):** 메모리 주소의 특정 비트를 캐시 라인의 인덱스로 사용합니다. 예를 들어, 32KB 캐시에서 64 Byte 캐시 라인을 사용한다면, 512개의 캐시 라인(32KB / 64B)이 있고, 이를 위한 9비트(2^9=512)의 인덱스가 필요합니다.
* **오프셋(Offset):** 캐시 라인 내의 특정 데이터를 찾기 위한 주소입니다. 64 Byte 캐시 라인은 6비트(2^6=64)의 오프셋을 사용합니다.
* **태그(Tag):** 캐시 라인의 주소를 식별하는 데 사용되는 주소의 나머지 상위 비트입니다. 캐시 메모리 내의 동일한 인덱스를 가진 여러 블록을 구분합니다.

#### 직접 매핑(Direct Mapping)
하나의 메모리 블록이 캐시 메모리의 특정 위치에만 매핑되는 방식입니다. 구조가 단순하고 빠르지만, 인덱스 충돌 시 다른 데이터가 덮어쓰여 캐시 미스가 자주 발생할 수 있습니다.

#### 세트 연관 매핑(Set-Associative Mapping)
직접 매핑과 완전 연관 매핑의 절충안입니다. 캐시를 여러 개의 '세트(Set)'로 나누고, 각 세트 안에 여러 개의 캐시 라인(Way)을 둡니다.
* **Way:** 하나의 인덱스에 여러 개의 캐시 라인이 할당되는 방식입니다(예: 2-Way, 4-Way). 이를 통해 인덱스 충돌이 발생하더라도 여러 개의 데이터를 저장할 수 있어 캐시 미스를 줄일 수 있습니다.

현대의 CPU는 주로 **세트 연관 매핑** 방식을 사용하며, 이를 통해 메모리 접근 패턴이 넓고 다양해진 현대 소프트웨어 환경에서 캐시 효율을 높입니다. 

---

### 캐시 메모리 용량 계산

* **L1 캐시:** 코어마다 분리되어 있으며, 데이터 캐시와 명령어 캐시로 나뉩니다.
* **L2 캐시:** 코어마다 분리되어 있거나, 코어 그룹이 공유합니다.
* **L3 캐시:** 모든 코어가 공유합니다(Intel Smart Cache).

**예시 계산:**
* 물리 코어 4개, L1 캐시 256KB, L2 캐시 1MB라고 가정.
* 코어당 L1 캐시 용량: 256KB / 4 = 64KB
* L1 데이터 캐시 용량(보통 1:1로 나눔): 64KB / 2 = 32KB
* L1 데이터 캐시 라인 개수: 32KB / 64Byte = 512개
* 인덱스 비트 수: `log2(512) = 9비트`

---

### 가상 메모리와 물리 메모리

* **가상 주소:** 프로그램이 사용하는 논리적인 주소입니다.
* **물리 주소:** RAM에 실제로 존재하는 주소입니다.
* **페이지(Page):** 가상 메모리 시스템에서 주소를 관리하는 단위(보통 4KB)입니다.
* **프레임(Frame):** 물리 메모리에서 페이지와 대응되는 단위입니다.

CPU가 캐시를 관리할 때 가상 주소와 물리 주소 중 어느 것을 사용할지 선택하는 문제는 성능과 복잡성에 영향을 미칩니다. 현대 CPU는 가상 주소의 일부 비트(인덱스, 오프셋)와 물리 주소의 일부 비트(태그)를 결합하는 방식을 사용하여 효율성과 예측 가능성을 모두 확보합니다. **가상 주소의 하위 12비트(4KB 페이지 오프셋)**는 물리 주소와 동일하다는 특성을 활용하여, 페이지 내에서의 캐시 인덱스와 오프셋은 항상 동일하게 유지되도록 설계됩니다. 이 때문에 캐시 메모리 용량은 커지지만 인덱스 비트 수를 무한정 늘릴 수 없어 Way의 수를 늘리는 방향으로 발전하고 있습니다.